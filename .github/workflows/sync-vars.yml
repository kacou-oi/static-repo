name: Sync Variables to Worker

on:
  workflow_dispatch:
  repository_dispatch:
    types: [sync-vars]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Inject Variables
        run: |
          WORKER_NAME="kacou-oi-websuite-worker"
          
          # Variables de base
          if [ -n "${{ secrets.ADMIN_EMAIL }}" ]; then
            echo "${{ secrets.ADMIN_EMAIL }}" | wrangler secret put ADMIN_EMAIL --name $WORKER_NAME
          fi
          
          if [ -n "${{ secrets.ADMIN_PASSWORD }}" ]; then
            echo "${{ secrets.ADMIN_PASSWORD }}" | wrangler secret put ADMIN_PASSWORD --name $WORKER_NAME
          fi
          
          if [ -n "${{ secrets.GITHUB_PAT }}" ]; then
            echo "${{ secrets.GITHUB_PAT }}" | wrangler secret put GITHUB_PAT --name $WORKER_NAME
          fi
          
          if [ -n "${{ secrets.GITHUB_USER }}" ]; then
            echo "${{ secrets.GITHUB_USER }}" | wrangler secret put GITHUB_USER --name $WORKER_NAME
          fi
          
          if [ -n "${{ secrets.GITHUB_REPO }}" ]; then
            echo "${{ secrets.GITHUB_REPO }}" | wrangler secret put GITHUB_REPO --name $WORKER_NAME
          fi
          
          # Autres variables optionnelles
          VARIABLES=(
            "BLOG_FEED_URL"
            "YOUTUBE_FEED_URL"
            "PODCAST_FEED_URL"
            "EVENTS_FEED_URL"
            "GOOGLE_AI_KEY"
            "OPENAI_API_KEY"
            "MISTRAL_AI_API_KEY"
            "DEEPSEEK_API_KEY"
            "DEEPL_API_KEY"
            "SUPABASE_URL"
            "SUPABASE_ANON_KEY"
            "CRONJOB_API_KEY"
            "PEXELS_API_KEY"
            "DYNAMICPDF_API_KEY"
            "APPSCRIPT_URL"
            "APPSCRIPT_GMAIL_URL"
            "APPSCRIPT_DRIVE_URL"
            "APPSCRIPT_DOCS_URL"
            "APPSCRIPT_SHEETS_URL"
            "APPSCRIPT_CALENDAR_URL"
            "APPSCRIPT_MEET_URL"
            "APPSCRIPT_FORMS_URL"
            "TWILIO_ACCOUNT_SID"
            "TWILIO_AUTH_TOKEN"
            "TWILIO_PHONE_NUMBER"
            "WHATSAPP_BUSINESS_ACCOUNT_ID"
            "WHATSAPP_ACCESS_TOKEN"
            "WHATSAPP_PHONE_NUMBER_ID"
            "WHATSAPP_VERIFY_TOKEN"
            "ZOOM_API_KEY"
            "ZOOM_API_SECRET"
            "ZOOM_ACCOUNT_ID"
          )
          
          for VAR in "${VARIABLES[@]}"; do
            SECRET_VALUE=$(eval echo "\${{ secrets.${VAR} }}")
            if [ -n "$SECRET_VALUE" ]; then
              echo "Injecting $VAR..."
              echo "$SECRET_VALUE" | wrangler secret put "$VAR" --name $WORKER_NAME
            fi
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
